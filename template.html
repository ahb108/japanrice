<!-- Stylesheets -->
<link rel="stylesheet" href="/static/css/ol.css" type="text/css">
<link rel="stylesheet" media="screen" href="https://cdnjs.cloudflare.com/ajax/libs/handsontable/0.12.3/handsontable.full.min.css">
<link rel="stylesheet" href="/static/vendor/fancybox/jquery.fancybox.css?v=2.1.5" type="text/css" media="screen" />
<style type="text/css">
	.ui-autocomplete {
		background-color: white;
		width: 300px;
		border: 1px solid #cfcfcf;
		list-style-type: none;
		padding-left: 0px;
	}
	label {
		font-size: 16px;
	}
	#map_canvas label {
		width: auto;
		display: inline;
	}
	#map_canvas img {
		max-width: none;
	}
	#imgContainer {
		height: 390px;
		width: 600px;
	}
	#map {
		height: 400px;
		width: 100%;
	}
</style>

<!-- Main scripts -->
<script src="/static/js/ol.js" type="text/javascript"></script>
<script src="/static/js/vendor/jquery.serializeJSON.min.js" type="text/javascript"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/openlayers/2.13.1/OpenLayers.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.0/jquery.cookie.min.js" type="text/javascript"></script>
<script src="/static/vendor/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>
<script src="http://code.jquery.com/ui/1.9.1/jquery-ui.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/handsontable/0.12.3/handsontable.full.min.js" type="text/javascript"></script>

<!-- Success and error messages for user -->
<div style="display:none;margin-top:15px; height:500px;" id="oldbrowser" class="row">
	<div  class="col-md-8 col-md-offset-1 alert alert-info">
		<h2> Browser problems! </h2>
		<p>
			Sorry, but your browser does not support the current application.
			If you want to contribute, please, upgrade to a modern web browser
			like the open source and free alternative
			<a href="http://www.mozilla.org/en-US/firefox/new/">Firefox</a> or <a href="https://www.google.com/intl/en/chrome/browser/">Chrome</a>.
		</p>
	</div>
</div>

<div style="margin-top:15px;">
	<div id="success" class="alert alert-success" style="display:none;">
		<strong>Well done!</strong> You have successfully submitted your transcription. Here is another to try if you wish!
	</div>
	<div id="loading" class="alert alert-info" style="display:none;">
		<img src="/static/img/loading.gif">Loading next task...
	</div>
	<div id="taskcompleted" class="alert alert-info" style="display:none;">
		<strong>The task has been completed,</strong> thanks a lot!
	</div>
	<div id="finish" class="alert alert-success" style="display:none;">
		<h2> Congratulations! </h2>
		<p>
			You have participated in <strong>all</strong> available tasks. Thank you for your interest and help.
		</p>
		<br/>
		<img src="https://crowdfunded.micropasts.org/assets/logo-head.png" width="200" height="200"/>
		<div class="alert-actions">
			<a class="btn-default btn" href="/">Go back</a>
			<a class="btn-default btn" href="/app">or, Check other applications</a>
		</div>
	</div>

	<div id="error" class="alert alert-error" style="display:none;">
		<a class="close">X.</a>
		<strong>Error!</strong> Something went wrong, please contact the site
		administrators via the forum, Twitter, email or our Facebook page.
	</div>
</div>
<!-- End of success and error messages for user -->

<!--
Task DOM for loading the Flickr Images
It uses the class="skeleton" to identify the elements that belong to the
task.
-->

<!-- Start Skeleton Row-->
<div class="row skeleton">
	<h1 id="start"> Please transcribe the data table(s) you see in this image. <br>スキャン画像の表に書かれた値を以下の空白セルに転記してください。</h1>

	<div id="step2">
		<h5>Transcribe the table shown in the scanned image into the empty cells below. <br>
			この画像の表のデータを転記してください。
		<br>
		(and choose 'Submit transcription' 入力完了後に「転記結果の提出 when finished 」をクリックしてください。)</h5>
		<div class="handsontable" id="data-table"></div>
		<button class="btn btn-submit" style="margin-top:5px;">
			Submit transcription /「転記結果の提出
		</button>
	</div>

</div>

<!-- Open Layers div -->
<div id="photo-link">
	<!-- Photo div -->
	<div id="imgHolder">
		<div class="btn-group">
			<a class="btn btn-info btn-sm" href="#" data-toggle="modal" title="Opens in a new window" data-target="#myModal"><i class="glyphicon glyphicon-eye-open"></i> Tutorial</a>
			<a class="btn btn-info btn-sm" rel="tooltip" target="_blank" data-toggle="tooltip" data-placement="top" title="Opens in a new window"  href="http://community.micropasts.org/category/crowd-sourcing-support"><i class="glyphicon glyphicon-book"></i> Community Help</a>
			<a id="raw" href="" class="btn btn-sm btn-info fancybox" ><i class="glyphicon glyphicon-picture"></i> Overlay</a>
			<a id="down" rel="tooltip" data-toggle="tooltip" data-placement="top" title="Only works for compliant browsers" download="" href="" class="btn btn-sm btn-info" ><i class="glyphicon glyphicon-download"></i> Download</a>
			<a id="flickr" rel="tooltip" target="_blank" data-toggle="tooltip" data-placement="top" title="Opens in a new window" href="" class="btn btn-sm btn-info"><i class="icon icon-flickr"></i> View on Flickr</a>
		</div>
		<!-- Container for zoomer -->
		<div id="imgContainer"></div>
		<div id="taskImg"></div>
		<!-- Feedback for user -->
		<p>
			<br>
			You are now working on task (現在作業中のタスク): <span id="task-id" class="label label-warning">#</span>
		</p>
		<p>
			You have completed (完了したタスク): <span id="done" class="label label-info"></span> tasks from (のうち) <!-- Progress bar for the user -->
			<span id="total" class="label label-inverse"></span>
		</p>
		<div class="progress progress-striped col-md-7">
			<div id="progress" rel="tooltip" title="#" class="progress-bar" role="progressbar" style="width: 0%;"></div>
		</div><!-- End of feedback row -->
	</div><!-- End of Photo DIV (columnt) -->
</div>
</div><!-- End of Skeleton Row -->

<!-- Modal start -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<!-- Stepped modal body -->
			<div class="modal-header">
				<h3 class="lead">Japanese Rice Statistics Tutorial <br>日本の稲作統計転記チュートリアル</h3>
			</div>

			<div id="0" class="modal-body" style="display:none">

				<p>
					This application is very simple. When you
					participate, the platform will load a scanned table of statistical
					data referring to rice production across Japan in the years 1883-1954. Once the image has been loaded, you will be asked
					to transcribe the contents of the table(s) you see in the image. Any further
					information can be placed in the top row, the bottom row or an
					extra final column. If you can read and write Japanese then please add these headings (with an English translation alongside if you can). If you cannot read Japanese then transcription of the numerical data will still be very useful (as the headings are standardised and we can add them later). 
					An example portion of a statistical table is provided below, 
					along with brief description of the contents of the Japanese headings.
				</p>
				<p>
					データの転記作業はシンプルです。このプロジェクトに参加すると、このシステムは1883年から1954年にかけての日本における稲作統計表のスキャン画像を読み込みます。画像が読み込まれると、画像にある統計表の内容を転記するように表示されます。統計表の最上段、最下段あるいは先頭列には、いくらかの情報が含まれていることがあります。日本語を書くことができる方は、そうした情報の（可能であれば英訳の併記も含め）も追加してください。日本語を読むことができない方であっても、数値データの転記も我々にとっては有益なものとなります（ヘッダー情報に関しては後に正規化して付け加えます）。以下には、内容に関する簡単な記述例として統計表の一部が例として示されています。
				</p>

				<img src="http://micropasts-other.s3.amazonaws.com/other/japanrice_example.png" class="img-polaroid"
				alt="An example of a rice production table" width="300" height="215"/>
			</div>
			<div id="1" class="modal-body" style="display:none">
				<p>
					Some further bits of guidance as you transcribe:
					<ul>
						<li>
							The number of rows will expand as you type. Please do not worry if you leave a blank final row.
							If a word is hard to decipher, do you best to identify it
							and make a comment in your extra column to note
							the problem. We have also split each sheet into two (with ovrelap), 
							so do not be surprised if you see a lack of headings and ignore any numbers/lines that are partially cut off.
						</li>
						<li>
							If you find it easier, you can transcribe into
							an offline spreadsheet and then copy-and-paste
							the results into the online table in one go. However, bear in mind that
							a delay in submitting the online table
							might then mean that other
							contributors complete this task before you do and
							thereby make your efforts unnecessary!
						</li>
					</ul>
				</p>
				<p>転記の際の注意事項:
					<ul>
						<li>行数については、入力を進めていくと自動的に追加されます。最終行が空白のままであることは問題ありません。判別が困難な文字や数字が合った場合には、最も妥当な判断で入力し、そうした問題に関するコメントを余分に用意した列に記入してください。統計表は二つに重ねて分割していますので、ヘッダー行が欠損していても驚かず、数値や行が切れてしまっていても無視して作業をおこなってください。</li>
						<li>簡単であると考えられる場合には、オフラインの表計算ソフトを使って転記し、その結果をコピー・アンド・ペーストでオンライン・テーブルに貼り付けることができます。しかしながら、データの提出が遅れた場合、他の協力者の方がそのタスクを完了させてしまっているかもしれません。その場合には、努力は水の泡となります！</li>
					</ul>
				</p>
			</div>
			<!-- End of stepped modal body -->
			<!-- Modal footer -->
			<div class="modal-footer">
				<a id="prevBtn" href="#" onclick="showStep('prev')" class="btn btn-default">Previous</a>
				<a id="nextBtn" href="#" onclick="showStep('next')" class="btn btn-success">Next</a>
				<button id="startContrib" data-dismiss="modal" class="btn btn-primary" style="display:none">
					<i class="glyphicon glyphicon-thumbs-up"></i> Let's start!</a>
			</div>
		</div>
	</div>
</div>
<!-- Modal end -->

<!-- Further scripts -->
<script>
	var step = -1;
	function showStep(action) {
		$("#" + step).hide();
		if (action == 'next') {
			step = step + 1;
		}
		if (action == 'prev') {
			step = step - 1;
		}
		if (step == 0) {
			$("#prevBtn").hide();
		} else {
			$("#prevBtn").show();
		}

		if (step == 1) {
			$("#nextBtn").hide();
			$("#startContrib").show();
		}
		$("#" + step).show();
	}

	showStep('next');
	$("#modal").modal('show'); 
</script>

<!-- Modernizer -->
<script>
	// fix for IE8
	Modernizr.load({
		test : window.JSON,
		nope : '/static/js/vendor/json2.min.js'
	}); 
</script>

<!-- Main Pybossa functions -->
<script>
	function loadUserProgress() {
		pybossa.userProgress('japanrice').done(function(data) {
			console.log(data);
			console.log("Total answers done for user: " + data.done);
			if ((data.done == 1) && ($.cookie('surveyricepops1') === undefined)) {
				$("#survey").modal('show');
				$.cookie('surveyricepops1', 'shown', {
					path : '/'
				});
			}
			if ((data.done == 25) && ($.cookie('survey25ricepops1') === undefined)) {
				$("#survey25").modal('show');
				$.cookie('survey25ricepops1', 'shown', {
					path : '/'
				});
			}
			var pct = Math.round((data.done * 100) / data.total);
			$("#progress").css("width", pct.toString() + "%");
			$("#progress").attr("title", pct.toString() + "% completed!");
			$("#progress").tooltip({
				'placement' : 'left'
			});
			$("#total").text(data.total);
			$("#done").text(data.done);
		});
	}
</script>

<script>
	pybossa.taskLoaded(function(task, deferred) {
		if (!$.isEmptyObject(task)) {
			var img = $('<img />');
			var div_map = $('<div/>');

			div_map.css("height", "390px");
			div_map.css("width", "600px");
			div_map.css("background", "#000");

			var extent = new OpenLayers.Bounds();
			extent.extend(new OpenLayers.LonLat(1.758939, 58.672231).transform(new OpenLayers.Projection("EPSG:4326"), new OpenLayers.Projection('EPSG:900913')));

			extent.extend(new OpenLayers.LonLat(-6.99745, 49.96112).transform(new OpenLayers.Projection("EPSG:4326"), new OpenLayers.Projection('EPSG:900913')));

			$("#imgContainer").append(div_map);
			div_map.attr("id", "img_" + task.id);

			task.pixelProjection = new ol.proj.Projection({
				code : 'pixel',
				units : 'pixels',
				extent : [0, 0, 1024, 720]
			});

			task.map_img = new ol.Map({
				//interactions: ol.interaction.defaults().extend([task.select, task.modify]),
				layers : [new ol.layer.Image({
					source : new ol.source.ImageStatic({
						url : task.info.url_o,
						imageSize : [1024, 720],
						projection : task.pixelProjection,
						imageExtent : task.pixelProjection.getExtent()
					})
				})],
				renderer : 'canvas',
				target : 'img_' + task.id,
				view : new ol.View({
					projection : task.pixelProjection,
					center : ol.extent.getCenter(task.pixelProjection.getExtent()),
					zoom : 1.0
				})
			});
			div_map.css("display", "none");

			// load image from flickr
			var img = $('<img />');
			img.attr("id", "img_task_" + task.id);
			img.load(function() {
				// continue as soon as the image is loaded
				deferred.resolve(task);
			});
			img.attr('src', task.info.url_o);
			img.attr('width', '390px');
			img.attr('height', '600px');
			img.addClass('img-polaroid');
			img.css("cursor", "zoom-in");
			task.info.image = img;

		} else {
			deferred.resolve(task);
		}

	}); 
</script>
<script>
	pybossa.presentTask(function(task, deferred) {
		if (!$.isEmptyObject(task)) {
			loadUserProgress();
			$("#step2").show();
			$("#step1").hide();
			$("#viewport_" + task.id).show();
			$("#nColumns").val("");
			$("a#raw").attr("href", task.info.url_o);
			$("a#flickr").attr("href", task.info.link);
			$("a#down").attr("download", task.id);
			$("a#down").attr("href", task.info.url_o);
			$(".fancybox").fancybox();
			$('#imgLink').tooltip();
			$("#question").html(task.info.question);
			$('#task-id').html(task.id);
			$("#img_" + task.id).show();

                var data = [[]];
                var config = {
                data: data,
                minRows: 6,
                minCols: 7,
                minSpareRows: 1,
                minSpareCols: 0,
                maxRows: 20,
                autoWrapRow: true,
                autoWrapCol: true,
                autoColumnSize: true,
                colHeaders: ['ID', 'Date', 'Description', 'Length (in inches)', 'Width (in inches)', 'Weight (in pounds.)', 'Weight (in ounces)'],
                contextMenu: ['row_below', 'remove_row', 'undo', 'redo'],
                stretchH: 'all'
                };
                $("#data-table").handsontable(config);
                
			});
		} else {
			$(".skeleton").hide();
			$("#loading").hide();
			$("#finish").fadeIn(500);
		}
	});

	if (Modernizr.borderradius) {
		pybossa.run('japanrice');
	} else {
		$(".skeleton").hide();
		$("#oldbrowser").show();
	}
</script>
